<!--
title: DockerNet Creation and Configuration
description: 
published: true
date: 2020-11-04T00:08:22.331Z
tags: 
editor: undefined
dateCreated: 2020-10-13T02:54:55.054Z
-->

<h1>DockerNet</h1>
<p>DockerNet is a MACVLAN network for docker containers.&nbsp; It requires configuration on the Docker host machine to create the network, and additional configuration on the router to access the network remotely.&nbsp; The configuration allows new docker images to appear on the network as individual devices with their own MAC addresses.&nbsp;</p>
<p>The primary reference used for creating this configuration is <a href="https://blog.oddbit.com/post/2018-03-12-using-docker-macvlan-networks/">Using Docker MACVLAN Networks</a>.&nbsp; The configuration had some issues with the checksum value in the packets being received.&nbsp; Unfortunately, I didn't document it well, but the solution is to disable the checksum offloading in eth0-shim as shown in the script below.</p>
<p>This script function assumes that it is run on a 192.168.1.0/24 subnet, and 192.168.1.3 is not in use.&nbsp; The script performs the following functions:</p>
<ol>
  <li>Remove the DockerNet MACVLAN network if it exists</li>
  <li>Create a virtual interface (<i>eth0-shim</i>) to act as a bridge between the MACVLAN and the host</li>
  <li>Create <i>/etc/network/interfaced.d/eth0-shim</i> to persist the configuration across boots</li>
  <li>Dynamically configure<i>&nbsp;eth0-shim</i> on the running system (NOTE: potential bug - address is not set to 192.168.1.3 explicitly)</li>
  <li><i>Eth0-shim</i> configuration include bridging all 192.168.40.x/24 containers from 192.168.1.x/24.</li>
  <li>Creates DockerNet, reserving 192.168.40.1 for the gateway, and 192.168.40.2 for <i>eth0-shim</i>.</li>
</ol>
<p>This script assumes that the physical interface to use is <i>eth0</i>.</p>
<p>In addition to the host configuration, the router must also be configured to allow traffic to get to DockerNet.&nbsp; The configuration and routing is shown in the following images used to configure the Ubiquiti Dream Machine:</p>
<figure class="image"><img src="/dockernet.png"></figure>
<figure class="image"><img src="/dockernetrouting.png"></figure>
<figure class="image"><img src="/dockernetfirewall.png"></figure>
<p>Currently, DockerNet is hosted on the Raspberry PI 4 (pi-hole).&nbsp; It can be created by using the following script function after configuring the routing.&nbsp; DockerNet is created once, then the network is used by the containers on the Raspberry PI 4.&nbsp;</p>
<p>The following script function creates the DockerNet on the PI:</p>
<p>&nbsp;</p>
<pre><code class="language-typescript"># 
# create_dockernet:
# 
#  &nbsp;This function creates the 'dockernet' MACVLAN network, using subnet 192.168.40.0/24.
#  &nbsp;This allows each docker container to appear to be connected to the physical network, 
#  &nbsp;with it's own MAC address.
#  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
function create_dockernet()
{
 &nbsp;# Reference:
 &nbsp;# https://blog.oddbit.com/post/2018-03-12-using-docker-macvlan-networks/

 &nbsp;# Routing requirements:
 &nbsp;#  &nbsp;&nbsp;1. Docker assigned addresses should not be used by the router
 &nbsp;#  &nbsp;&nbsp;2. Routes need to be created to access the subnet residing on the docker host
 &nbsp;#  &nbsp;&nbsp;3. Secondary MACVLAN (eth0-shim) used to connect containers to host
 &nbsp;#
 &nbsp;#############################################
 &nbsp;#
 &nbsp;#  The following routes must be configured
 &nbsp;#  on the router to connect to the containers 
 &nbsp;#  in the 192.168.40.0/24 subnet . 
 &nbsp;#
 &nbsp;#############################################
 &nbsp;#  192.168.40.0/24 dev br40 scope link  src 192.168.40.1 
 &nbsp;#  192.168.40.0/31 dev br0  metric 1 
 &nbsp;#  192.168.40.2 via 192.168.1.3 dev br0  metric 1 
 &nbsp;#  192.168.40.4/30 dev br0  metric 1 
 &nbsp;#  192.168.40.8/29 dev br0  metric 1 
 &nbsp;#  192.168.40.16/28 dev br0  metric 1 
 &nbsp;#  192.168.40.32/27 dev br0  metric 1 
 &nbsp;#  192.168.40.64/26 dev br0  metric 1 
 &nbsp;#  192.168.40.128/25 dev br0  metric 1 
 &nbsp;############################################

 &nbsp;printf "Creating dockernet. "

 &nbsp;# Start from scratch
 &nbsp;if docker network ls | grep  dockernet &gt;/dev/null 2&gt;&amp;1; then
 &nbsp;&nbsp;&nbsp;docker network remove dockernet
 &nbsp;fi

 &nbsp;#
 &nbsp;# Create dockernet corresponding to same definition in router
 &nbsp;#  &nbsp;Uses router DHCP settings which are currently allocating 192.168.40.128 - 192.168.40.255 (192.168.40.128/25)
 &nbsp;#

 &nbsp;# Create eth0-shim MACVLan interface for communication between the host
 &nbsp;#  and the MACVlan network
 &nbsp;sudo rm -f /etc/network/interfaces.d/eth0-shim || true
 &nbsp;SHIM_CFG=$(mktemp)

 &nbsp;# Public MAC addresses use these ranges:
 &nbsp;#  &nbsp;x2-xx-xx-xx-xx-xx
 &nbsp;#  &nbsp;x6-xx-xx-xx-xx-xx
 &nbsp;#  &nbsp;xA-xx-xx-xx-xx-xx
 &nbsp;#  &nbsp;xE-xx-xx-xx-xx-xx
 &nbsp;#
 &nbsp;# The range selected was arbitrary, x2-xx-xx-xx-xx-xx.  The
 &nbsp;# last four segments are mapped to the IP address to prevent
 &nbsp;# internal network conflicts.
 &nbsp;#  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 &nbsp;MAC_ADDR="02:00:C0:A8:01:03"

 &nbsp;#
 &nbsp;# Make ethtool is installed to provide support to disable
 &nbsp;# checksum offloading.
 &nbsp;#
 &nbsp;echo sudo apt install -y ethtool
 &nbsp;sudo apt install -y ethtool || true

 &nbsp;#
 &nbsp;# Create the MACVlan bridge configuration file for the host,
 &nbsp;# to make the interface persistent across boots.  Also, if the
 &nbsp;# interface is not defined, issue the network commands to create
 &nbsp;# the interface immediately.
 &nbsp;#
 &nbsp;sudo cat &lt;&lt;***REMOVED*** &gt;${SHIM_CFG}
auto eth0-shim
iface eth0-shim inet static
 address 192.168.1.3
 pre-up ip link add eth0-shim link eth0 type macvlan mode bridge
 up ip addr add 192.168.40.2/32 dev eth0-shim  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 up ip link set eth0-shim address ${MAC_ADDR} up
 up ip route add 192.168.40.0/31 dev eth0-shim
 up ip route add 192.168.40.3/32 dev eth0-shim
 up ip route add 192.168.40.4/30 dev eth0-shim
 up ip route add 192.168.40.8/29 dev eth0-shim
 up ip route add 192.168.40.16/28 dev eth0-shim
 up ip route add 192.168.40.32/27 dev eth0-shim
 up ip route add 192.168.40.64/26 dev eth0-shim
 up ip route add 192.168.40.128/25 dev eth0-shim
 offload-tso  off
***REMOVED***
 sudo mv ${SHIM_CFG} /etc/network/interfaces.d/eth0-shim

 if ! ip addr show eth0-shim &gt;/dev/null 2&gt;&amp;1; then  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 &nbsp;&nbsp;&nbsp;# Add a shim ethernet to act as a bridge to the host machine
 &nbsp;&nbsp;&nbsp;sudo ip link add eth0-shim link eth0 type macvlan mode bridge
 &nbsp;&nbsp;&nbsp;sudo ip addr add 192.168.40.2/32 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip link set eth0-shim address ${MAC_ADDR} up

 &nbsp;&nbsp;&nbsp;# Route all the addresses through the shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.0/31 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.3/32 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.4/30 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.8/29 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.16/28 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.32/27 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.64/26 dev eth0-shim
 &nbsp;&nbsp;&nbsp;sudo ip route add 192.168.40.128/25 dev eth0-shim
 &nbsp;fi
 &nbsp;sudo ethtool -K eth0-shim tso off || true

  #
  # Enable promiscuous mode for eth0                                                                                                                                           
  #   The parent interface (eth0) for the MACVLAN must be
  #   in promiscuous mode to allow multiple VLANs on the interface
  #
  sudo rm -f /etc/network/interfaces.d/eth0 || true
  ETH0_CFG=$(mktemp)
  sudo cat &lt;&lt;***REMOVED*** &gt;${ETH0_CFG}
auto eth0
iface eth0 inet static 
  address 192.168.1.2/24
  gateway 192.168.1.1
  up /sbin/ip -4 link set eth0 promisc on
  down /sbin/ip link set eth0 promisc off
  down /sbin/ip link set eth0 down
***REMOVED***
  sudo mv ${ETH_CFG} /etc/network/interfaces.d/eth0

  sudo ip link set eth0 promisc on

 &nbsp;# Use the MACVLan driver - allowing docker containers to appear as if physically connected to network
 &nbsp;DOCKER_OPTIONS="  -d macvlan"
 &nbsp;# Specify the physical interface to use
 &nbsp;DOCKER_OPTIONS+=" -o parent=eth0"
 &nbsp;# Set the subnet to use for the network.  The router will also define this subnet as a VLAN.
 &nbsp;DOCKER_OPTIONS+=" --subnet 192.168.40.0/24"  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 &nbsp;# Define the external gateway machine.  Ubiquiti provides this virtual gateway in the router.
 &nbsp;DOCKER_OPTIONS+=" --gateway 192.168.40.1"  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
 &nbsp;# Define the IP range for containers that don't specify an IP address
 &nbsp;DOCKER_OPTIONS+=" --ip-range 192.168.40.128/25"  &nbsp;&nbsp;&nbsp;&nbsp; 
 &nbsp;# Reserve an address to use for the MACVLAN bridge (eth0-shim) communication with host
 &nbsp;DOCKER_OPTIONS+=" --aux-address "'host=192.168.40.2'
 &nbsp;docker network create ${DOCKER_OPTIONS} dockernet
 
 &nbsp;printf "Done.\n"
}</code></pre>
